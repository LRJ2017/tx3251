<!DOCTYPE html>
<html lang="en">

    <head>
        
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>TX3251传输模块配置</title>

        <!-- CSS -->
        <link rel="stylesheet" href="assets/bootstrap/css/bootstrap.min.css">
        <link rel="stylesheet" href="assets/font-awesome/css/font-awesome.min.css">
        <link rel="stylesheet" href="assets/css/animate.css">
        <link rel="stylesheet" href="assets/css/magnific-popup.css">
        <link rel="stylesheet" href="assets/flexslider/flexslider.css">
        <link rel="stylesheet" href="assets/css/form-elements.css">
        <link rel="stylesheet" href="assets/css/style.css">
        <link rel="stylesheet" href="assets/css/media-queries.css">

        <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
        <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
        <!--[if lt IE 9]>
            <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
            <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
        <![endif]-->

        <!-- Favicon and touch icons -->
        <link rel="shortcut icon" href="assets/ico/favicon.ico">
        <link rel="apple-touch-icon-precomposed" sizes="144x144" href="assets/ico/apple-touch-icon-144-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="114x114" href="assets/ico/apple-touch-icon-114-precomposed.png">
        <link rel="apple-touch-icon-precomposed" sizes="72x72" href="assets/ico/apple-touch-icon-72-precomposed.png">
        <link rel="apple-touch-icon-precomposed" href="assets/ico/apple-touch-icon-57-precomposed.png">

    </head>

    <body>
        
        <!-- Top menu -->
		<nav class="navbar" role="navigation">
			<div class="container">
				<div class="navbar-header">
					<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#top-navbar-1">
						<span class="sr-only">&nbsp;</span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
						<span class="icon-bar"></span>
					</button>
					<a class="navbar-brand" href="index.html">&nbsp;</a>
				</div>
				<!-- Collect the nav links, forms, and other content for toggling -->
				<div class="collapse navbar-collapse" id="top-navbar-1">
					<ul class="nav navbar-nav navbar-right">
						<li>
							<a href="main.html"><i class="fa fa-calendar" style="font-size:35px;color:green;"></i><br>设备状态</a>
						</li>
						<li>
							<a href="ctrConfig.html"><i class="fa fa-cogs" style="font-size:35px;color:green;"></i><br>控制器设置</a>
						</li>
						<li>
							<a href="ipConfig.html"><i class="fa fa-sitemap" style="font-size:35px;color:green;"></i><br>网络设置</a>
						</li>
						<li>
							<a href="waterConfig.html"><i class="fa fa-tint" style="font-size:35px;color:green;"></i><br>水系统配置</a>
						</li>
						<li>
							<a href="update.html"><i class="fa fa-angle-double-up" style="font-size:40px;color:green;"></i><br>设备升级</a>
						</li>
						<li class="active">
							<a href="debugLog.html"><i class="fa fa-key" style="font-size:40px;color:green;"></i><br>调试日志</a>
						</li>
					</ul>
				</div>
			</div>
		</nav>

        <!-- Slider -->
        <div class="slider-container">
			<iframe name="server" style="display:none;" src=' '></iframe> 
			<form id="debugForm" name="debugForm" action="/cgi-bin/debugLog.cgi" method="POST" target="server" ENCTYPE="multipart/form-data">
			<table  id="table"  width="60%" border="1px" align="center"  border-radius="5px" >
            <caption align="top" style="font-size:24px ;font-weight:bold;color:red" >日志显示</caption>
          	<tr>
          		<td align="left" style="color: black;font-weight:bold;" width="150">&nbsp;&nbsp;日志类型:&nbsp;&nbsp;</td>
          		<td align="left">
			   	<input type="radio" id=AppLog name="logtype" value="0" onclick="APP(this)">模块运行日志
			   	&nbsp;&nbsp;&nbsp;&nbsp;
			   	<input type="radio" id=ControllerLog name="logtype" value="1" checked="checked" onclick="CONTROLLER(this)">控制器通讯日志
			   	&nbsp;&nbsp;&nbsp;&nbsp;
			   	<input type="radio" id=ServerPlatformsLog name="logtype" value="2" onclick="SERVERPLATFORM(this)">云平台通讯日志
			   	&nbsp;&nbsp;&nbsp;&nbsp;
			   	<input type="radio" id=AlarmPlatformsLog name="logtype" value="3" onclick="ALARMPLATFORM(this)">信息解析日志
			   	</td>
			</tr>
			<tr>
			    <td align="left" colspan="2" style="color:black;font-weight:bold;">&nbsp;&nbsp;日志内容:&nbsp;&nbsp;</td>
			</tr>
			<tr>
			   <td align="left" colspan="2">
					<textarea name="log_content" id="log_content_id" style="background:black; color:white; width:100%; height:300px; resize:none; border-radius:0px"></textarea>
              </td>
			</tr>
			<tr>
				<td align="middle"  colspan="2" style="height:60px;">
                	<input class ="button" Style="border-radius:5px;background:green;width:150px;height:40px;font-size:24px ;font-weight:bold;color:white" id="btnStartDebug" input type="button" name="btnStartDebug" onclick="StartDebug()"  value="开始调试">
                </td>
			</tr>
			</table>
			</form>		
        </div>

        <!-- Footer -->
        <footer>
            <div class="container">
                <div class="row">
                    <div class="footer-copyright wow fadeIn" style="height:50px;">
                        <p>&copy; 中消云物联网科技研究院</p>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Javascript -->
        <script src="assets/js/jquery-1.11.1.min.js"></script>
        <script src="assets/bootstrap/js/bootstrap.min.js"></script>
        <script src="assets/js/bootstrap-hover-dropdown.min.js"></script>
        <script src="assets/js/jquery.backstretch.min.js"></script>
        <script src="assets/js/wow.min.js"></script>
        <script src="assets/js/retina-1.1.0.min.js"></script>
        <script src="assets/js/jquery.magnific-popup.min.js"></script>
        <script src="assets/flexslider/jquery.flexslider-min.js"></script>
        <script src="assets/js/jflickrfeed.min.js"></script>
        <script src="assets/js/masonry.pkgd.min.js"></script>
        <script src="assets/js/jquery.ui.map.min.js"></script>
        <script src="assets/js/scripts.js"></script>

<script type="text/javascript">

var txtObj = document.getElementById("log_content_id");
var h = window.innerHeight - 350;
txtObj.style.height = h + "px";

var xhr;
function createXHR()
{ 
	try
    {
	   // Firefox, Opera 8.0+, Safari
	    xhr=new XMLHttpRequest();
    }
	catch (e)
	{
	  // Internet Explorer
		try
	    {
	    	xhr=new ActiveXObject("Msxml2.XMLHTTP");
	    }
	    catch (e)
	    {
	    	try
	        {
	         	xhr=new ActiveXObject("Microsoft.XMLHTTP");
	     	}
	  		catch (e)
	     	{
	     		alert("您的浏览器不支持AJAX！");
	     		return false;
	     	}
	  	}
	}
	return xhr;
}

var log_type_selected=1;
var read_index=0;
var start_debug_flag=0;

function DebugLogCallback()
{
    if (xhr.readyState == 4) 
    {
        if (xhr.status == 200) 
        {
			var returnValue = xhr.responseText;
			
			if(returnValue != null && returnValue.length > 0)
			{
				process_tx3251_log(returnValue);
			}
			else
			{
				console.log("结果为空！");
				SendDebugCmd();
			}
        } 
        else 
        {
           console.log("页面出现异常！");
           SendDebugCmd();
        }
    }
}

var APP = function(dom) 
{
    if (dom.checked) 
    {
    	log_type_selected=0;
    	read_index = 0;
    }
}

var CONTROLLER = function(dom) 
{
    if (dom.checked) 
    {
    	log_type_selected=1;
    	read_index = 0;
    }
}

var SERVERPLATFORM = function(dom) 
{
    if (dom.checked) 
    {
    	log_type_selected=2;
    	read_index = 0;
    }
}

var ALARMPLATFORM = function(dom) 
{
    if (dom.checked) 
    {
    	log_type_selected=3;
    	read_index = 0;
    }
}


function addURLParam(url,name,value){  
  url += (url.indexOf('?')==-1 ? '?' : '&');  
  url += encodeURIComponent(name) + '=' + encodeURIComponent(value);  
  return url;  
}  

function SendDebugCmd()
{
	if(start_debug_flag == 0)
	{
		return;
	}
	
	//debugLog.cgi后面跟个cur_time参数是为了防止Ajax页面缓存
	var url = "/cgi-bin/debugLog.cgi";
	// 添加参数
	url = addURLParam(url, "open", start_debug_flag);
	url = addURLParam(url, "type", log_type_selected);
	url = addURLParam(url, "readindex", read_index);
	url = addURLParam(url,"time", new Date().getTime());
	// 初始化请求
	xhr.open("get", url);
	xhr.send(null);
}
	
function StartDebug()
{
	var btnObj = document.getElementById("btnStartDebug");
	if(start_debug_flag == 0)
	{
		if(prompt("请输入校验密码！") != pwd)
		{
			return;
		}
		
		start_debug_flag = 1;	
		btnObj.style.background = "red";
		read_index=0;
		var text = "停止调试";
		btnObj.value = text;
	}
	else
	{  		
		start_debug_flag = 0;
		var text = "开始调试";
		btnObj.value = text;
		btnObj.style.background = "green";
	}
	var xhr;
	xhr = createXHR();	
	if(xhr)
	{
		xhr.onreadystatechange=DebugLogCallback;
		SendDebugCmd();
	}
	else
	{
	    //XMLHttpRequest对象创建失败
	    alert("浏览器不支持，请更换浏览器！");
	}
}

//开始调试后，请求定时器
var timer;
/*****数据处理函数****/
function process_tx3251_log(returnValue){
	//以/\n切割字符串
	var str0 = returnValue.split('**/**');
	if ( !Array.prototype.forEach ) //判定浏览器是否支持foreach函数,解决IE无法支持的问题
	{

		Array.prototype.forEach = function forEach( callback, thisArg ) 
		{		
			var T, k;
			
			if ( this == null )
			{
				throw new TypeError( "this is null or not defined" );
			}
			var O = Object(this);
			var len = O.length >>> 0; 
			if ( typeof callback !== "function" ) 
			{
				throw new TypeError( callback + " is not a function" );
			}
			if ( arguments.length > 1 ) 
			{
				T = thisArg;
			}
			k = 0;			
			while( k < len )
			{			
				var kValue;
				if ( k in O ) 
				{			
					kValue = O[ k ];
					callback.call( T, kValue, k, O );
				}
				k++;
			}
		};
	}
	var cur_text = document.getElementById("log_content_id").value;
	var new_text = "";	
	str0.forEach(function (eachData){
		//以=切割字符串	
		var str1 = eachData.split("**=**");
		switch(str1[0]){
			case "cur_offset":
				read_index = Number(str1[1]);
				break;
			case "cur_log_content":
				new_text = str1[1];
				break;
			case "readend":
				xhr.abort();
				break;
		}
	}
	)
	var txtObj = document.getElementById("log_content_id");
	txtObj.value = cur_text + new_text;
	txtObj.scrollTop = txtObj.scrollHeight;
	timer = setTimeout(function (){
				SendDebugCmd();
			},500);
	if(start_debug_flag == 0)
	{
		clearInterval(timer);
	}

}
</script>

</body>
</html>